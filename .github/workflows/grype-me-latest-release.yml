
name: Grype_Me Scan (latest release)

on:
  schedule:
    - cron: "53 6 * * *"   # daily 06:53 UTC - after Grype DB update (approx 06:15 UTC)
  release:
    types: [published]
  workflow_dispatch: {}

permissions:
  contents: write           # README-Update + Commit

env:
  REPO: TomTonic/rtcompare

jobs:
  scan-latest-release:
    runs-on: ubuntu-latest

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit
  
      - name: Checkout default branch (for README commit)
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Scan latest release for vulnerabilities
        id: grype-scan
        uses: TomTonic/grype_me@v1
        with:
          scan: 'latest_release'

      - name: Resolve latest release info (REST)
        id: rel
        run: |
          set -euo pipefail

          if [ "${GITHUB_EVENT_NAME}" = "release" ]; then
            tag=$(jq -r '.release.tag_name' "$GITHUB_EVENT_PATH")
            html_url=$(jq -r '.release.html_url' "$GITHUB_EVENT_PATH")
          else
            API="https://api.github.com/repos/${REPO}/releases/latest"
            
            # Capture both HTTP status code and response body
            response=$(curl -sSL -w "\n%{http_code}" \
                            -H "Accept: application/vnd.github+json" \
                            -H "X-GitHub-Api-Version: 2022-11-28" "$API")
            
            # Extract status code (last line) and body (everything else)
            http_code=$(echo "$response" | tail -n1)
            json=$(echo "$response" | sed '$d')
            
            # Check HTTP status code
            if [ "$http_code" != "200" ]; then
              echo "Error: GitHub API returned HTTP $http_code for $API" >&2
              if [ "$http_code" = "404" ]; then
                echo "No releases found for repository ${REPO}. Please create a release first." >&2
              fi
              exit 1
            fi
            
            # Validate JSON response before parsing
            if ! echo "$json" | jq empty 2>/dev/null; then
              echo "Error: Invalid JSON response from GitHub API" >&2
              echo "Response: $json" >&2
              exit 1
            fi
            
            tag=$(jq -r '.tag_name' <<<"$json")
            html_url=$(jq -r '.html_url' <<<"$json")
          fi

          if [ -z "${tag}" ] || [ "${tag}" = "null" ]; then
            echo "Error: No release tag found in API response or event payload." >&2
            exit 1
          fi

          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "html_url=$html_url" >> "$GITHUB_OUTPUT"

      - name: Update README block
        run: |
          set -euo pipefail
          START="<!-- grype-me-scan:start -->"
          END="<!-- grype-me-scan:end -->"

          RELEASE_TAG="${{ steps.rel.outputs.tag }}"
          RELEASE_URL="${{ steps.rel.outputs.html_url }}"

          GRYPE_VERSION="${{ steps.grype-scan.outputs.grype-version }}"
          if [[ "$GRYPE_VERSION" == v* ]]; then
            GRYPE_VERSION_TAG="$GRYPE_VERSION"
          else
            GRYPE_VERSION_TAG="v$GRYPE_VERSION"
          fi
          GRYPE_URL="https://github.com/anchore/grype/releases/tag/${GRYPE_VERSION_TAG}"

          LINE1="Daily supply chain vulnerability scan of [rtcompare ${RELEASE_TAG}](${RELEASE_URL}): **${{ steps.grype-scan.outputs.cve-count }} CVE's** (${{ steps.grype-scan.outputs.critical }} critical, ${{ steps.grype-scan.outputs.high }} high, ${{ steps.grype-scan.outputs.medium }} medium, ${{ steps.grype-scan.outputs.low }} low severity). Used [grype version ${GRYPE_VERSION}](${GRYPE_URL}) with DB ${{ steps.grype-scan.outputs.db-version }}. Used [grype_me](https://github.com/TomTonic/grype_me)."

          NEW_BLOCK="${START}\n${LINE1}\n${END}"

          awk -v start="$START" -v end="$END" -v repl="$NEW_BLOCK" '
            BEGIN{found=0; inblock=0}
            {
              line = $0
              # Trim leading and trailing spaces/tabs before comparing to markers
              gsub(/^[ \t]+|[ \t]+$/, "", line)

              if (line == start) {
                print repl
                inblock = 1
                found = 1
              } else if (line == end) {
                inblock = 0
              } else if (!inblock) {
                print $0
              }
            }
            END{
              if (found==0){
                print "ERROR: markers not found" > "/dev/stderr"
                exit 1
              }
            }
          ' README.md > README.tmp && mv README.tmp README.md

      - name: Commit and push if changed
        run: |
          if git diff --quiet -- README.md; then
            echo "No README changes."
          else
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add README.md
            git commit -m "Automated CVE scan of release ${{ steps.rel.outputs.tag }} (grype_me)"
            git push
          fi
